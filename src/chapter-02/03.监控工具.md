## 监控工具
在本节中，我们将讨论监控工具。大多数工具都是在 Enterprise Linux 发行版中提供的。您应该熟悉这些工具。

### top
top 命令实时显示进程活动。默认情况下，top 显示占用 CPU 最多的任务，并每 5 秒更新一次列表。您也可以按 PID（数值）、age（最新在前）、time（累积时间）、驻留内存（resident memory）使用情况和 time（进程自启动以来占用 CPU 的时间）对进程进行排序。

```{#lst:example_top .bash caption="top 命令输出示例"}
top - 19:41:32 up 15 days, 19:49,  1 user,  load average: 0.25, 0.21, 0.18
Tasks: 189 total,   1 running, 188 sleeping,   0 stopped,   0 zombie
%Cpu(s):  1.3 us,  5.1 sy,  0.0 ni, 93.6 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :   3793.3 total,    250.2 free,    815.1 used,   2727.9 buff/cache
MiB Swap:      0.0 total,      0.0 free,      0.0 used.   2927.1 avail Mem 

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
 699270 ubuntu    20   0   10688   3084   2716 R  17.6   0.1   0:00.05 top
      1 root      20   0  173720  14292   7472 S   0.0   0.4  15:09.93 systemd
      2 root      20   0       0      0      0 S   0.0   0.0   0:03.27 kthreadd
      3 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_gp
      4 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_par_gp
      8 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 mm_percpu_wq
      9 root      20   0       0      0      0 S   0.0   0.0   6:39.65 ksoftirqd/0
     10 root      20   0       0      0      0 I   0.0   0.0  19:52.54 rcu_preempt
     11 root      rt   0       0      0      0 S   0.0   0.0   0:10.36 migration/0
     12 root     -51   0       0      0      0 S   0.0   0.0   0:00.00 idle_inject/0
     14 root      20   0       0      0      0 S   0.0   0.0   0:00.00 cpuhp/0
     15 root      20   0       0      0      0 S   0.0   0.0   0:00.00 cpuhp/1
     16 root     -51   0       0      0      0 S   0.0   0.0   0:00.00 idle_inject/1
     17 root      rt   0       0      0      0 S   0.0   0.0   0:10.14 migration/1
     18 root      20   0       0      0      0 S   0.0   0.0   0:41.60 ksoftirqd/1
```

您可以使用 **renice** 进一步修改进程，为每个进程赋予新的优先级。当某个进程挂起或占用过多 CPU 时，可以使用 **kill** 命令杀死该进程。

各列的含义：

PID
:	进程标识

USER
:	拥有（可能是启动）进程的用户名。

PRI^[原文为 PRI，应对应 top 输出的 PR]
:	进程的优先级。（详见 1.1.4 节 “进程优先级和 nice 级别”)

NI
:	nice 级别（进程是否尝试通过给定的数字调整优先级来达到亲和性。详情请看下文）。

SIZE^[原文为 SIZE，应对应 top 输出的 VIRT]
:	进程使用的内存数量（code+data+stack），单位为千字节。

RSS^[原文为 RSS，应对应 top 输出的 RES]
:	使用的物理 RAM 数量，单位为千字节。

SHARE^[原文为 SHARE，应对应 top 输出的 SHR]
:	与其他进程共享的内存量，单位为千字节。

STAT^[原文为 STAT，应对应 top 输出的 S]
:	进程状态：S=休眠（sleeping），R=运行（running），T=停止或跟踪（stopped or traced），D =可中断睡眠（interruptible sleep），Z =僵尸（zombie）。参见 1.1.7 节“进程状态”。

%CPU
:	CPU 使用率（自上次屏幕更新以来）。

%MEM
:	内存使用率

TIME
:	进程使用的总 CPU 时间（自它启动以来）。

COMMAND
:	用于启动任务的命令行（包括参数）。

top 实用程序支持几个有用的热键，包括：

t
:	显示摘要信息开关。

m 
:	显示内存信息开关。

A 
:	根据各种系统资源的顶级消费者对显示进行排序，有助于快速识别系统中影响性能的任务。

f 
:	进入 **top** 的交互式配置屏幕。有助于为特定的任务设置 **top**。

o
:	使您能够交互式地选择顶部的排序。

r
:	执行 **renice** 命令。

k 
:	执行 **kill** 命令。

### vmstat
vmstat 提供有关进程、内存、分页、block I/O、traps 和 CPU 活动的信息。vmstat 命令显示平均数据或实时采样值。通过向 vmstat 提供采样频率和采样持续时间，可以启用采样模式。

::: {.warn}
在采样模式下，考虑实际数据收集之间出现峰值的可能性。将采样频率降到一个较低的值可以避免错过这些隐藏的峰值。
:::

```{#lst:vmstat .bash caption="vmstat 的输出示例"}
ubuntu@ubuntu:~$ vmstat 2
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 0  1      0 253180 203836 2589972    0    0     1    51    1    5  1  1 98  0  0
 1  0      0 253432 203836 2589972    0    0     0   480 1078 1579  1  1 97  1  0
 0  0      0 253432 203836 2589972    0    0     0   526 1104 1588  1  1 96  1  0
 1  1      0 253432 203836 2589972    0    0     0   438  874 1280  1  1 96  2  0
 0  0      0 253464 203836 2589972    0    0     0   358 1007 1415  1  1 87 11  0
 0  0      0 253464 203836 2589972    0    0     0   528  895 1293  1  1 97  1  0
```

::: {.info}
vmstat 报告的第一行数据显示了自上次重新引导以来的平均值，因此应该删除它。
:::

vmstat 的输出列如下：

Process (procs)
:	r: 等待运行时的进程数
	b: 处于不可中断休眠状态的进程数

Memory
:	swpd: 使用的虚拟内存数量 (KB)
	free: 空闲内存数量 (KB)
	buff: 作为缓冲区使用的内存数量 (KB)
	cache: The amount of memory used as cache (KB)

Swap
:	si: 从磁盘换入的内存数量 (KBps)
	so: 换出到磁盘的内存数量 (KBps)

IO
:	bi: 发送到块设备的块 (blocks/s)
	bo: 从块设备接收的块 (blocks/s)

System
:	in: 每秒钟中断的数量，包括时钟中断
	cs：每秒上下文切换的数量

CPU(% of total CPU time)
:	us: 运行非内核代码的时间（用户时间，包括 nice time）。
	sy: 运行内核代码所花费的时间（系统时间）。
	id: 空闲的时间。在 Linux 2.5.41 之前，这包括 I/O 等待时间。
	wa: 等待 IO 的时间。在 Linux 2.5.41 之前，这个值为 0。

vmstat 命令支持大量的命令行参数，这些参数在 vmstat 的手册页中有完整的记录。一些更有用的标志包括：

-m
:	显示内核的内存利用率（slabs）

-a
:	提供有关活动和非活动内存页的信息

-n
:	只显示一个标题行（do not redisplay header），如果需要在采样模式下运行 vmstat 并通过管道将结果输出到文件中，这个参数很有用。（例如，`root# vmstat -n 2 10` 以 2 秒的频率采样 10 次）。

当与 `-p` {partition} 标志^[ -p, --partition <dev>  partition specific statistics，如 vmstat -p /dev/sda1] 一起使用时，**vmstat** 还提供 I/O 统计信息。

### uptime
可以使用 uptime 命令查看服务器已经运行了多长时间，有多少用户登录，以及快速概述服务器的平均负载。（请参阅 1.6.1 节“处理器指标”)。uptime 可以显示过去 1 分钟、5 分钟和 15 分钟的系统平均负载值。

负载的最佳值是 1，这意味着每个进程都可以立即访问 CPU，并且不会错过 CPU 周期。典型的负载可能因系统而异。对于单处理器工作站，1 或 2 可能是可以接受的，而在多处理器服务器上，您可能会看到值为 8 到 10。

您可以使用 **uptime** 来确定是服务器还是网络出了问题。例如，如果一个网络应用程序运行得很差，执行 **uptime** 您将看到系统负载是否很高。如果不是，则问题更可能与您的网络有关，而不是与您的服务器。

::: {.info}
你可以用 **w** 代替 **uptime**。**w** 命令还提供有关当前登录到计算机的用户以及用户正在做什么的信息。
:::

```{#lst:uptime_output .bash caption="uptime 输出示例"}
 21:33:35 up 16 days, 21:41,  1 user,  load average: 0.22, 0.20, 0.18
```

### ps and pstree
当涉及到系统分析时，**ps** 和 **pree** 命令是一些最基本的命令。**ps** 可以有 3 种不同类型的命令选项，UNIX 风格、BSD 风格和 GNU 风格。这里我们看看 UNIX 风格的选项。

**ps** 命令提供现有进程的列表。**top** 命令显示进程信息，但是 **ps** 将提供更详细的信息。列出的进程数量取决于所使用的选项。一个简单的 `ps -A` 命令列出了所有进程及其各自的进程 ID（PID），这些进程 ID 对进一步的研究至关重要。为了使用 **pmap** 或 **renice** 等工具，需要一个 PID 数字。

在运行 Java™ 应用程序的系统上，`ps -A` 命令的输出可能会很容易地填满显示，以至于很难获得所有正在运行的进程的完整图像。在这种情况下，**pstree** 命令可能会派上用场，因为它以树结构显示正在运行的进程，并合并生成的子进程（例如，Java 线程）。**pstree** 命令可以帮助识别原始进程。还有另一种 **ps** 变体，**pgrep**。这可能也很有用。

```{#lst:ps_output .bash caption="ps 输出示例"}
ubuntu@ubuntu:~$ ps -A
    PID TTY          TIME CMD
      1 ?        00:19:25 systemd
      2 ?        00:00:04 kthreadd
      3 ?        00:00:00 rcu_gp
      4 ?        00:00:00 rcu_par_gp
      8 ?        00:00:00 mm_percpu_wq
      9 ?        00:11:32 ksoftirqd/0
     10 ?        00:27:53 rcu_preempt
     11 ?        00:00:13 migration/0
```

以下是一些 **ps** 常用的选项。

-e
:	同 **-A**，显示所有进程

-l 
:	显示为长格式

-F 
:	完整模式（Extra full mode）

-H
:	层次结构显示（Forest）

-L 
:	显示线程，可能使用 LWP 和 NLWP 列

-m 
:	在进程之后显示线程

[@lst:ps_detail] 是使用 `ps -elFL` 参数的详细输出示例。

```{#lst:ps_detail .bash caption="ps 详细输出示例"}
ubuntu@ubuntu:~$ ps -elFL
F S UID          PID    PPID     LWP  C NLWP PRI  NI ADDR SZ WCHAN    RSS PSR STIME TTY          TIME CMD
4 S root           1       0       1  0    1  80   0 - 43430 -      14292   2 Aug02 ?        00:19:24 /lib/systemd/systemd --system --deserialize 86
1 S root           2       0       2  0    1  80   0 -     0 -          0   1 Aug02 ?        00:00:04 [kthreadd]
1 I root           3       2       3  0    1  60 -20 -     0 -          0   0 Aug02 ?        00:00:00 [rcu_gp]
1 I root           4       2       4  0    1  60 -20 -     0 -          0   0 Aug02 ?        00:00:00 [rcu_par_gp]
1 I root           8       2       8  0    1  60 -20 -     0 -          0   0 Aug02 ?        00:00:00 [mm_percpu_wq]
1 S root           9       2       9  0    1  80   0 -     0 -          0   0 Aug02 ?        00:11:33 [ksoftirqd/0]
1 I root          10       2      10  0    1  80   0 -     0 -          0   0 Aug02 ?        00:27:54 [rcu_preempt]
1 S root          11       2      11  0    1 -40   - -     0 -          0   0 Aug02 ?        00:00:13 [migration/0]
5 S root          12       2      12  0    1   9   - -     0 -          0   0 Aug02 ?        00:00:00 [idle_inject/0]
```

[@lst:ps_detail] 中输出各列的含义如下：

F
:	进程标志（Process flag）

S
:	进程状态：S=sleeping, R=running, T=stopped or traced,D=interruptable sleep, Z=zombie. 进程状态更深入的讨论见 1.1.7 节的 “进程状态”。

UID
:	拥有（可能是启动）进程的用户。

PID
:	进程 ID。

PPID
:	父进程 ID。

LWP
:	LWP（light weight process,or thread 轻量级进程或线程）所报告的 LWP 的 ID。

C 
:	处理器利用率百分比的整数值。(CPU 使用）。

NLWP
:	进程中的 lwps（线程）数量。（别名 thcount)。

PRI
:	进程的优先级。（详见 1.1.4 节的 “进程优先级和 nice 级别”)。

NI
:	亲和性（Niceness）级别（进程是否通过根据给定的数字调整优先级来尝试达到亲和性）。

ADDR
:	进程地址空间（未显示）

SZ
:	进程使用的内存数量（代码+数据+堆栈），单位为千字节。

WCHAN
:	进程处于休眠状态的内核函数的名称，如果进程正在运行，则用 "-" 表示；如果进程是多线程的，且 ps 没有显示线程，则用 "*" 表示。

RSS
:	常驻内存集大小，任务使用的非交换物理内存（单位为千字节）。

PSR
:	当前分配给该进程的处理器。

STIME
:	命令开始执行的时间。

TTY
:	终端（Terminal）。

TIME
:	进程使用的总 CPU 时间（自它启动以来）。

CMD
:	用于启动任务的命令行（包括参数）。

#### 线程信息
可以使用 `ps -L` 选项查看线程信息。

```{#lst:ps_thread .bash caption="ps -L 输出"}
[root@edam ~]# ps -eLF| grep -E "LWP|/usr/sbin/httpd"
UID    PID PPID  LWP  C NLWP SZ RSS PSR STIME TTY TIME CMD
root   4504 1    4504 0 1 4313 8600 2 08:33 ? 00:00:00 /usr/sbin/httpd
apache 4507 4504 4507 0 1 4313 4236 1 08:33 ? 00:00:00 /usr/sbin/httpd
apache 4508 4504 4508 0 1 4313 4228 1 08:33 ? 00:00:00 /usr/sbin/httpd
apache 4509 4504 4509 0 1 4313 4228 0 08:33 ? 00:00:00 /usr/sbin/httpd
apache 4510 4504 4510 0 1 4313 4228 3 08:33 ? 00:00:00 /usr/sbin/httpd

[root@edam ~]# ps -eLF| grep -E "LWP|/usr/sbin/httpd"
UID    PID PPID  LWP  C NLWP SZ  RSS PSR STIME TTY TIME  CMD
root   4632 1    4632 0 1  3640  7772 2 08:44 ? 00:00:00 /usr/sbin/httpd.worker
apache 4635 4632 4635 0 27 72795 5352 3 08:44 ? 00:00:00 /usr/sbin/httpd.worker
apache 4635 4632 4638 0 27 72795 5352 1 08:44 ? 00:00:00 /usr/sbin/httpd.worker
apache 4635 4632 4639 0 27 72795 5352 3 08:44 ? 00:00:00 /usr/sbin/httpd.worker
apache 4635 4632 4640 0 27 72795 5352 3 08:44 ? 00:00:00 /usr/sbin/httpd.worker
```

### free

### iostat

### sar

### mpstat

### numastat

### pmap

### netstat

### iptraf

### tcpdump/ethereal

### nmon

### strace

### Proc file system

### KED System Guard

### Gnome System Monitor

### 容量管理