## 磁盘 I/O 子系统
在处理器解码和执行指令之前，先从磁盘扇区中读取数据并存入处理器缓存和寄存器中。执行的结果会被写回磁盘。

我们将研究 Linux 磁盘 I/O 子系统，以便更好地理解对系统性能有重大影响的组件。

### I/O 子系统架构
I/O 子系统的基本概念如 [@fig:io_arch] 所示。

![I/O 子系统架构](images/io_arch.jpg){#fig:io_arch width=70%}

为了快速概述整个 I/O 子系统操作，我们将使用一个将数据写入磁盘的示例。下面的步骤概述了执行磁盘写操作时发生的基本操作。假设文件数据在磁盘上的扇区上，已经被读取，并且在页面缓存中。

1. 进程通过 `write()` 系统调用请求写入文件。
2. 内核更新映射到文件的页面缓存（_page cache_）。
3. `pdflush` 内核线程负责将页面缓存刷新到磁盘。
4. 文件系统层将每个块缓冲区放在一个 _bio_ 结构中（参见 1.4.3 节中的 “Block layer” )，并向块设备层提交写请求。
5. 块设备层从上层获取请求，执行 I/O 提升（_I/O elevator_）操作，并将请求放入 I/O 请求队列中。
6. 设备驱动程序（如 SCSI 或其他特定于设备的驱动程序）将负责写操作。
7. 磁盘设备固件执行硬件操作，如查找磁头、旋转和数据传输到盘片上的扇区。

### 缓存
在过去的 20 年里，处理器的性能改进已经超过了计算机系统中的其他组件，如处理器缓存、总线、RAM、磁盘等。对内存和磁盘的较慢访问限制了整体系统性能，因此系统性能不能通过处理器速度的提高而得到提高。缓存机制通过在更快的内存中缓存频繁使用的数据来解决这个问题。它减少了访问较慢内存的机会。目前的计算机系统几乎在所有 I/O 组件中都使用了这种技术，如硬盘驱动器缓存、磁盘控制器缓存、文件系统缓存、由每个应用程序处理的缓存，等等。

#### 内存层级（Memory Hierarchy）
[@fig:memory_hierarchy] 展示了内存层次结构的概念。由于 CPU 寄存器和磁盘之间的访问速度差异很大，CPU 将花费更多的时间等待来自低速磁盘设备的数据，因此这将大大降低 CPU 的优势。内存层次结构通过在 CPU 和磁盘之间放置 L1 缓存、L2 缓存、RAM 和其他一些缓存来减少这种不匹配。它使进程获得更少的机会访问较慢的内存和磁盘。靠近处理器的内存速度更快，体积更小。

该技术还利用了访问局部性原则（_locality of reference principle_）。在更快的内存中，缓存命中率越高，对数据的访问就越快。

![内存层级](images/memory_hierarchy.jpg){#fig:memory_hierarchy}

#### 访问局部性（Locality of reference）
正如我们在前面的“内存层级”中所述，实现更高的缓存命中率是提高性能的关键。为了达到更高的缓存命中率，使用了一种叫做“访问局部性”的技术。该技术基于以下原则：

- 最近使用的数据很有可能在不久的将来被使用（时间局部性 _temporal locality_）。
- 与已使用的数据相近的数据被使用的概率很高（空间局部性 _spatial locality_）。

[@fig:locality] 说明了此原则。

![访问局部性](images/locality.jpg){#fig:locality width=80%}

Linux 在许多组件中使用了这一原则，例如页面缓存、文件对象缓存 (i-node 缓存、目录条目缓存，等等）、预读缓存（_read ahead buffer_）等等。

#### 刷新脏缓冲（Flushing a dirty buffer）
当进程从磁盘读取数据时，数据被复制到内存中。进程和其他进程可以从缓存在内存中的数据副本中检索相同的数据。当进程试图更改数据时，它首先更改内存中的数据。此时，磁盘上的数据和内存中的数据并不相同，内存中的数据被称为脏缓冲区（_dirty buffer_）。脏缓冲区应该尽快与磁盘上的数据同步，否则如果突然发生崩溃，内存中的数据可能会丢失。

脏缓冲区的同步过程称为刷新（_flush_）。在 Linux 内核 2.6 实现中，`pdflush` 内核线程负责将数据刷新到磁盘。当内存中脏缓冲区的比例超过某个阈值 (bdflush) 时，刷新会定期发生 (kupdate)。阈值可在 `/proc/sys/vm/dirty_background_ratio` 文件里调整。有关更多信息，请参阅 4.5.1 节，“设置内核交换和 pdflush 行为”。

![刷新脏缓冲](images/flushing_dirty_buffers.jpg){#fig:flushing_dirty_buffers width=80%}

### 块设备层

### I/O 设备驱动

### RAID 和存储系统